{% extends "base.html" %}
{% block title %}My Drafting Workspace{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <h2>📄 Drafting Workspace</h2>
  <p><strong>Filename:</strong> {{ session.pdf_file.name }}</p>

  <div class="row">
    <!-- LEFT: PDF Viewer -->
    <div class="col-md-6 mb-3">
      <embed src="{% url 'serve_pdf' session.id %}" type="application/pdf" width="100%" height="600px" style="border: 1px solid #ccc;" />
    </div>

    <!-- RIGHT: Whiteboard -->
    <div class="col-md-6">
      <canvas id="whiteboard" style="width: 100%; height: 600px; border: 1px solid #ccc;"></canvas>

      <!-- Toolbar -->
      <div class="mt-2 d-flex flex-wrap gap-2">
        <button class="btn btn-dark btn-sm" onclick="changeColor('black')">🖊️ Black</button>
        <button class="btn btn-danger btn-sm" onclick="changeColor('red')">🖍️ Red</button>
        <button class="btn btn-primary btn-sm" onclick="changeColor('blue')">🔵 Blue</button>
        <button class="btn btn-secondary btn-sm" onclick="erase()">❌ Erase</button>
        <button class="btn btn-warning btn-sm" onclick="clearCanvas()">🧹 Clear</button>
        <button class="btn btn-success btn-sm" onclick="saveCanvas()">💾 Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Canvas Drawing Script -->
<script>
  const canvas = document.getElementById('whiteboard');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let currentColor = 'black';
  let currentPage = 1;
  const maxPages = {{ max_pages }};
  const pageImages = {{ page_images|safe }};

  function resizeCanvas() {
    let tempImage = null;
    if (canvas.width && canvas.height) {
      tempImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
    }
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    if (tempImage) {
      ctx.putImageData(tempImage, 0, 0);
    }
  }

  function loadPage(page) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (pageImages[page]) {
      const img = new Image();
      img.onload = function() {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
      img.src = pageImages[page];
    }
  }

  function goToPage(page) {
    if (page < 1 || page > maxPages) return;
    currentPage = page;
    loadPage(currentPage);
    document.getElementById('page-indicator').innerText = `Page ${currentPage} of ${maxPages}`;
  }

  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  window.addEventListener('DOMContentLoaded', function() {
    goToPage(1);
  });

  canvas.addEventListener('mousedown', () => drawing = true);
  canvas.addEventListener('mouseup', () => {
    drawing = false;
    ctx.beginPath();
  });
  canvas.addEventListener('mousemove', draw);

  function draw(e) {
    if (!drawing) return;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = currentColor;

    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  }

  function changeColor(color) {
    currentColor = color;
    ctx.beginPath();
  }

  function erase() {
    currentColor = 'white';
    ctx.beginPath();
  }

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function saveCanvas() {
    const imageData = canvas.toDataURL("image/png");
    fetch("{% url 'save_canvas_image' session.id %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ image_data: imageData, page_number: currentPage })
    }).then(response => {
      if (response.ok) {
        alert("✅ Draft saved successfully!");
        // Optionally update pageImages[currentPage] with new imageData
      } else {
        alert("❌ Failed to save draft.");
      }
    }).catch(error => {
      console.error(error);
      alert("⚠️ Something went wrong.");
    });
  }
</script>

<div class="mt-2">
  <button class="btn btn-outline-secondary btn-sm" onclick="goToPage(currentPage-1)">Previous Page</button>
  <span id="page-indicator">Page 1 of {{ max_pages }}</span>
  <button class="btn btn-outline-secondary btn-sm" onclick="goToPage(currentPage+1)">Next Page</button>
</div>

<div class="mt-3">
  <a href="{% url 'draft_list' %}" class="btn btn-secondary">← Back to Drafts</a>
</div>
{% endblock %}

